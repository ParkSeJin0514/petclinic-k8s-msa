---
# ============================================================================
# Visits Service Deployment
# ============================================================================
# Spring Boot ÎßàÏù¥ÌÅ¨Î°úÏÑúÎπÑÏä§ - Î∞©Î¨∏ Í∏∞Î°ù Í¥ÄÎ¶¨
# - MySQL Database ÌïÑÏöî
# - Eureka Discovery ServerÏóê Îì±Î°ù
# - Config ServerÏóêÏÑú ÏÑ§Ï†ï Î°úÎìú
# ============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: visits-service
  namespace: petclinic
  labels:
    app: visits-service
    tier: business
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: visits-service
  template:
    metadata:
      labels:
        app: visits-service
        tier: business
        version: v1
    spec:
      containers:
        - name: visits-service
          image: springcommunity/spring-petclinic-visits-service:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8082
              protocol: TCP
          
          # Resource Limits
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          
          # Health Checks
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8082
            initialDelaySeconds: 200
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 15
          
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8082
            initialDelaySeconds: 120
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 5
          
          # Environment Variables
          env:
            # Spring Profile
            - name: SPRING_PROFILES_ACTIVE
              value: "kubernetes,mysql"
            
            # Server Port (Í∞ïÏ†ú Í≥†Ï†ï - Ï§ëÏöî!)
            - name: SERVER_PORT
              value: "8082"
            
            # Config Server (Ï≤´ Î≤àÏß∏ Ïö∞ÏÑ†ÏàúÏúÑ)
            - name: CONFIG_SERVER_URL
              value: "http://config-server:8888"
            
            # üî• Eureka ÏÑ§Ï†ïÏùÑ JSONÏúºÎ°ú Í∞ïÏ†ú Ï†ÅÏö©
            - name: SPRING_APPLICATION_JSON
              value: |
                {
                  "eureka": {
                    "instance": {
                      "preferIpAddress": true
                    },
                    "client": {
                      "serviceUrl": {
                        "defaultZone": "http://discovery-server:8761/eureka/"
                      }
                    }
                  }
                }
            
            # Database Configuration (SecretÏóêÏÑú Î°úÎìú)
            - name: SPRING_DATASOURCE_URL
              valueFrom:
                secretKeyRef:
                  name: petclinic-db-secret
                  key: SPRING_DATASOURCE_URL
            
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: petclinic-db-secret
                  key: SPRING_DATASOURCE_USERNAME
            
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: petclinic-db-secret
                  key: SPRING_DATASOURCE_PASSWORD
            
            # JPA/Hibernate ÏÑ§Ï†ï
            - name: SPRING_JPA_HIBERNATE_DDL_AUTO
              value: "update"
            
            - name: SPRING_JPA_SHOW_SQL
              value: "false"
            
            # Connection Pool ÏÑ§Ï†ï
            - name: SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE
              value: "10"
            
            - name: SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE
              value: "5"

---
# ============================================================================
# Visits Service
# ============================================================================
apiVersion: v1
kind: Service
metadata:
  name: visits-service
  namespace: petclinic
  labels:
    app: visits-service
    tier: business
spec:
  selector:
    app: visits-service
  ports:
    - name: http
      port: 8082
      targetPort: 8082
      protocol: TCP
  type: ClusterIP
